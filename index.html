<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Radar</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        canvas {
            border: 1px solid black;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #map {
            display: none;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }
        #token {
            padding: 5px;
            font-size: 14px;
        }
        #startButton {
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="controls">
            <input type="text" id="token" placeholder="Enter Token">
            <button id="startButton" onclick="startVisualization()">Start Visualization</button>
        </div>
        <canvas id="radar" width="1024" height="1024"></canvas>
        <img id="map" alt="Map">
    </div>
    <script>
        let source;
        const canvas = document.getElementById('radar');
        const context = canvas.getContext('2d');
        const mapImage = document.getElementById('map');
        let currentPlayerPos = null;

        // Scaling factors and offsets (default values for all maps, to be customized)
        const defaultScaleX = 0.07774464204685025;
        const defaultScaleY = 0.06763396382050703;
        const defaultOffsetX = 408.0429488385525;
        const defaultOffsetY = 817.6971110723387;

        // Map data
        const maps = {
            1: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/abyss_map.svg', rotate: true },
            2: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/ascent_map.svg', rotate: true },
            3: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/bind_map.svg', rotate: true },
            4: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/breeze_map.svg', rotate: true },
            5: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/fracture_map.svg', rotate: true },
            6: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/haven_map.svg', rotate: true },
            7: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/icebox_map.svg', rotate: true },
            8: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/lotus_map.svg', rotate: true },
            9: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/pearl_map.svg', rotate: true },
            10: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/split_map.svg', rotate: true },
            11: { url: 'https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/sunset_map.svg', rotate: true }
        };

        // Agent icons mapping
        const agentIcons = [
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/raze.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/viper.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/omen.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/sova.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/sage.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/phoenix.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/jett.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/cypher.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/brimstone.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/breach.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/reyna.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/killjoy.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/skye.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/yoru.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/astra.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/kayo.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/chamber.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/neon.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/fade.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/harbor.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/gekko.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/deadlock.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/iso.png",
            "https://cdn.mobalytics.gg/assets/valorant/images/agents/icons/clove.png"
        ];

        const agentImages = [];

        function preloadAgentIcons() {
            return new Promise((resolve, reject) => {
                let loadedImages = 0;
                for (let i = 0; i < agentIcons.length; i++) {
                    const img = new Image();
                    img.src = agentIcons[i];
                    img.onload = () => {
                        loadedImages++;
                        if (loadedImages === agentIcons.length) {
                            resolve();
                        }
                    };
                    img.onerror = reject;
                    agentImages[i] = img;
                }
            });
        }

        function loadMapImage(map_id) {
            const map = maps[map_id];
            if (map) {
                mapImage.src = map.url;
                return map;
            }
            return null;
        }

        mapImage.onload = function() {
            drawMap();
        };

        function drawMap(map) {
            // Clear canvas
            context.clearRect(0, 0, canvas.width, canvas.height);

            context.save();
            context.translate(canvas.width / 2, canvas.height / 2);

            if (map && map.rotate) {
                context.rotate(-90 * Math.PI / 180);
            }

            context.drawImage(mapImage, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
            context.restore();
        }

        function startVisualization() {
            const token = document.getElementById('token').value;
            source = new EventSource(`https://link.elocarry.net/data/${token}`);
            source.onmessage = function(event) {
                let data = JSON.parse(event.data);

                if (data.map_id) {
                    const map = loadMapImage(data.m);
                    drawMap(map);
                }

                if (data.ps.length > 0) {
                    currentPlayerPos = data.ps[0].p;
                }

                updateRadar(data);
            };
        }

        function convertToMapPosition(realX, realY, map) {
            const scaleX = map?.scaleX || defaultScaleX;
            const scaleY = map?.scaleY || defaultScaleY;
            const offsetX = map?.offsetX || defaultOffsetX;
            const offsetY = map?.offsetY || defaultOffsetY;

            const mapX = realX * scaleX + offsetX;
            const mapY = realY * scaleY + offsetY;
            return { mapX, mapY };
        }

        function updateRadar(data) {
            const map = maps[data.map_id];
            drawMap(map);

            // Draw players
            data.ps.forEach(player => {
                // Convert real position to map position
                let { mapX, mapY } = convertToMapPosition(player.p[0], player.p[1], map);

                // Draw the icon
                const img = agentImages[player.a]; // player.a is the agent ID

                if (img) {
                    const iconSize = 24; // 25% smaller than 32
                    context.drawImage(img, mapX - iconSize / 2, mapY - iconSize / 2, iconSize, iconSize);

                    // Draw the outline
                    const radius = iconSize / 2;
                    context.beginPath();
                    context.arc(mapX, mapY, radius + 3, 0, 2 * Math.PI); // Radius increased by 3 for the outline
                    context.lineWidth = 3;
                    const outlineColor = player.t === 1 ? 'lightblue' : 'red';
                    context.strokeStyle = outlineColor;
                    context.stroke();

                    // Draw direction indicator based on look_direction
                    context.fillStyle = outlineColor;
                    context.beginPath();
                    let angleRad = player.l[0] * (Math.PI / 180);
                    context.moveTo(mapX + radius * Math.cos(angleRad), mapY + radius * Math.sin(angleRad));
                    context.lineTo(mapX + (radius + 10) * Math.cos(angleRad - Math.PI / 6), mapY + (radius + 10) * Math.sin(angleRad - Math.PI / 6));
                    context.lineTo(mapX + (radius + 10) * Math.cos(angleRad + Math.PI / 6), mapY + (radius + 10) * Math.sin(angleRad + Math.PI / 6));
                    context.closePath();
                    context.fill();
                }
            });
        }

        canvas.addEventListener('click', function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            console.log(`Clicked position: (${x}, ${y})`);

            if (currentPlayerPos) {
                const { mapX, mapY } = convertToMapPosition(currentPlayerPos[0], currentPlayerPos[1]);
                console.log(`Current player position on map: (${mapX}, ${mapY})`);
                console.log(`Actual player position: (${currentPlayerPos[0]}, ${currentPlayerPos[1]})`);
            }
        });

        // Preload agent icons before starting visualization
        preloadAgentIcons().then(() => {
            console.log('All agent icons preloaded.');
        }).catch((error) => {
            console.error('Error preloading agent icons:', error);
        });
    </script>
</body>
</html>
