<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Radar</title>
    <style>
        canvas {
            border: 1px solid black;
        }
        #map {
            display: none;
        }
    </style>
</head>
<body>
    <input type="text" id="token" placeholder="Enter Token">
    <button onclick="startVisualization()">Start Visualization</button>
    <canvas id="radar" width="1024" height="1024"></canvas>
    <img id="map" src="https://cdn.mobalytics.gg/assets/valorant/images/maps/levels/ascent_map.svg" alt="Ascent Map">
    <script>
        let source;
        const canvas = document.getElementById('radar');
        const context = canvas.getContext('2d');
        const mapImage = document.getElementById('map');
        let currentPlayerPos = null;

        // Simplified scaling factors
        const scaleX = (485.546875 - 627.546875) / (1126.2659 - 2680.8884);
        const scaleY = (71 - 70) / (1126.2659 - 2680.8884); // This value is almost zero, as y-coordinate changes minimally.
        
        // Simplified offsets based on the first point
        const offsetX = 627.546875 - scaleX * 2680.8884;
        const offsetY = 70 - scaleY * -11057.992;
        
        mapImage.onload = function() {
            drawMap();
        };

        function drawMap() {
            // Draw the map rotated by 45 degrees counter-clockwise
            context.save();
            context.translate(canvas.width / 2, canvas.height / 2);
            context.rotate(-90 * Math.PI / 180);
            context.drawImage(mapImage, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
            context.restore();
        }

        function startVisualization() {
            const token = document.getElementById('token').value;
            source = new EventSource(`https://link.elocarry.net/data/${token}`);
            source.onmessage = function(event) {
                let data = JSON.parse(event.data);
                if (data.ps.length > 0) {
                    currentPlayerPos = data.ps[0].p;
                }
                updateRadar(data);
            };
        }

        function updateRadar(data) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            drawMap();

            // Draw players
            data.ps.forEach(player => {
                let x = scaleX * player.p[0] + offsetX;
                let y = scaleY * player.p[1] + offsetY;
                
                context.fillStyle = player.t === 1 ? 'blue' : 'red';
                context.beginPath();
                context.arc(x, y, 5, 0, 2 * Math.PI);
                context.fill();

                // Draw direction indicator based on look_direction
                context.strokeStyle = 'black';
                context.beginPath();
                let angleRad = player.l[0] * (Math.PI / 180);
                context.moveTo(x, y);
                context.lineTo(x + 10 * Math.cos(angleRad), y + 10 * Math.sin(angleRad));
                context.stroke();
            });
        }

        canvas.addEventListener('click', function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            console.log(`Clicked position: (${x}, ${y})`);

            if (currentPlayerPos) {
                console.log(`Current player position: (${currentPlayerPos[0]}, ${currentPlayerPos[1]})`);
            }
        });
    </script>
</body>
</html>
